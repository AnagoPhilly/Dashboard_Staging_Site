<!DOCTYPE html>
<html>
<head>
    <title>CleanDash Admin Importer</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 700px; }
        h1 { color: #0d9488; margin-top: 0; border-bottom: 2px solid #f0fdfa; padding-bottom: 15px; margin-bottom: 20px; }
        .upload-box { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px; background: #f8fafc; margin: 20px 0; }
        select, .checkbox-wrapper { width: 100%; margin-bottom: 15px; font-size: 1rem; }
        select { padding: 12px; border-radius: 6px; border: 1px solid #d1d5db; background: white; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; background: #e0f2fe; padding: 10px; border-radius: 6px; border: 1px solid #bae6fd; color: #0369a1; font-weight: 600; box-sizing: border-box;}
        button { background: #0d9488; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; transition: 0.2s; }
        button:hover { background: #0f766e; }
        button.disabled-state { background: #9ca3af !important; cursor: not-allowed; opacity: 0.7; }
        .log-window { background: #1f2937; color: #10b981; padding: 15px; height: 300px; overflow-y: auto; border-radius: 8px; margin-top: 20px; font-family: monospace; font-size: 0.85rem; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #374151; padding-bottom: 2px; }
        .log-warn { color: #f59e0b; }
        .log-error { color: #ef4444; font-weight: bold; }
        .log-success { color: #34d399; font-weight: bold; }
        .btn-sync { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
        .btn-sync:hover { background: #dbeafe; }
        .btn-danger { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
        .btn-danger:hover { background: #ef4444; }
        #authWarning { display:none; background:#fee2e2; color:#991b1b; padding:15px; border-radius:8px; text-align:center; font-weight:bold; margin-bottom:20px; border:1px solid #f87171; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Admin Data Importer</h1>
    <div id="authWarning">üîí Access Denied. Must be logged in as Admin.</div>

    <div id="appContent" style="opacity:0.5; pointer-events:none;">
        <label style="font-weight:bold; color:#374151;">Select Import Type:</label>
        <select id="importType">
            <option value="master">1. Active Master List (Upsert & Update)</option>
            <option value="cancelled">2. Cancelled Client List (Set Inactive)</option>
            <option value="history">3. Legacy Account History (Initial Setup)</option>
        </select>

        <div class="checkbox-wrapper">
            <input type="checkbox" id="geoEnabled" checked>
            <label for="geoEnabled">Auto-Fix Map Coordinates (Adds ~0.6s per row)</label>
        </div>

        <div class="upload-box">
            <input type="file" id="uploadCsv" accept=".csv" />
        </div>

        <button id="btnUpload" class="disabled-state" disabled onclick="processFile()">üöÄ Start Import</button>
        <button onclick="runSmartSync()" class="btn-sync">üß† Run Smart Sync (Fix Missing Owner Addresses)</button>

        <div id="status" style="margin-top:15px; text-align:center; font-weight:bold; color: #4b5563; min-height: 20px;"></div>
        <div id="log" class="log-window"></div>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="checkRecordCount()" style="background:#e0f2fe; color:#0369a1;">üìä Check Master Count</button>
            <button onclick="wipeMasterList()" class="btn-danger">üóëÔ∏è Wipe Master Data</button>
        </div>
    </div>
</div>

<script src="js/auth.js"></script>
<script src="js/utils.js"></script>

<script>
    const ALLOWED_ADMIN_EMAIL = 'nate@anagophilly.com';
    // Note: Ensure your API Key is secure in production
    const API_KEY = window.LOCATIONIQ_KEY || "pk.c92dcfda3c6ea1c6da25f0c36c34c99e";

    // Initialize Firebase (Assuming already initialized in js/auth.js, if not, add config here)
    // const firebaseConfig = { ... };
    // firebase.initializeApp(firebaseConfig);
    //const db = firebase.firestore();

    firebase.auth().onAuthStateChanged(user => {
        const warningBox = document.getElementById('authWarning');
        const appContent = document.getElementById('appContent');
        const btn = document.getElementById('btnUpload');

        if (user && user.email && user.email.toLowerCase() === ALLOWED_ADMIN_EMAIL.toLowerCase()) {
            warningBox.style.display = 'none';
            appContent.style.opacity = '1';
            appContent.style.pointerEvents = 'auto';
            btn.disabled = false;
            btn.classList.remove('disabled-state');
        } else {
            warningBox.style.display = 'block';
            appContent.style.opacity = '0.5';
            appContent.style.pointerEvents = 'none';
        }
    });

    function log(msg, type='info') {
        const l = document.getElementById('log');
        let cls = 'log-entry';
        if(type==='warn') cls += ' log-warn';
        if(type==='error') cls += ' log-error';
        if(type==='success') cls += ' log-success';
        l.innerHTML += `<div class="${cls}">> ${msg}</div>`;
        l.scrollTop = l.scrollHeight;
    }

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // --- GEOCODING UTILITY ---
    async function getCoordinates(street, city, state, zip) {
        if (!street && !city) return null;
        try {
            const baseUrl = "https://us1.locationiq.com/v1/search.php";
            const params = new URLSearchParams({
                key: API_KEY,
                street: street,
                city: city,
                state: state,
                postalcode: zip,
                format: 'json',
                limit: 1,
                countrycodes: 'us'
            });

            const res = await fetch(`${baseUrl}?${params.toString()}`);
            const data = await res.json();
            if (data && data[0]) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        } catch (e) { console.log("Geo error", e); }
        return null;
    }

    function processFile() {
        const file = document.getElementById('uploadCsv').files[0];
        const mode = document.getElementById('importType').value;
        if(!file) return alert("Select CSV");
        const btn = document.getElementById('btnUpload');
        btn.disabled = true; btn.classList.add('disabled-state'); btn.innerText = "Processing...";

        Papa.parse(file, {
            header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
            complete: function(results) {
                if(mode === 'master') uploadMasterList(results.data);
                else if(mode === 'cancelled') uploadCancelledList(results.data);
                else uploadHistoryBook(results.data);
            },
            error: function(err) { alert(err.message); btn.disabled = false; }
        });
    }

    // --- HELPER: Map Fran ID to Owner Email ---
    async function getFranIdMap() {
        log("Fetching Franchise Owners map...");
        const map = {};
        const snap = await db.collection('users').where('role', '==', 'owner').get();
        snap.forEach(doc => {
            const data = doc.data();
            if (data.franId) {
                map[data.franId.toUpperCase()] = data.email;
            }
        });
        log(`Loaded ${Object.keys(map).length} Franchise Owners.`);
        return map;
    }

    // --- 1. IMPROVED ACTIVE MASTER LIST IMPORT (UPSERT) ---
async function uploadMasterList(data) {
log(`Starting Active Master List Sync (${data.length} records)...`);
const doGeo = document.getElementById('geoEnabled').checked;

// 1. Get Owner Map
const franMap = await getFranIdMap();

let batch = db.batch();
let count = 0;
let updatedCount = 0;
let orphanCount = 0; // Track accounts with no owner

for (const row of data) {
    const pid = row['Client ID'] || row['Clientid'];
    if (!pid) continue;

    // Formatting
    const addr = (row['Site Address'] || '').trim();
    const city = (row['Site City'] || '').trim();
    const state = (row['Site State'] || '').trim() || 'PA';
    const zip = (row['Site Zip'] || '').trim();
    const fullAddress = [addr, city, state, zip].filter(Boolean).join(', ');
    const franId = (row['Fran ID'] || '').trim().toUpperCase();

    // Geocoding Logic
    let lat = null, lng = null;
    if (doGeo && addr.length > 3) {
        await sleep(650);
        const coords = await getCoordinates(addr, city, state, zip);
        if (coords) { lat = coords.lat; lng = coords.lng; log(`üìç Pin found for: ${pid}`); }
    }

    // Data Object
    const clientData = {
        pid: pid,
        status: 'Active',
        name: row['Service Loc'] || row['Service Location Name'] || '',
        address: fullAddress,
        street: addr, city: city, state: state, zip: zip,
        revenue: parseFloat((row['Recur Amt']||'0').replace(/[$,]/g, '')),
        contactName: row['Contact Name'] || '',
        contactPhone: row['Contact Phone'] || '',
        contactEmail: row['Contact Email'] || '',
        franId: franId,
        startDate: formatDate(row['Start Date']),
        endDate: null,
        inactiveReason: null,
        lastImportedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    if (lat) { clientData.lat = lat; clientData.lng = lng; }

    // 1. Update ADMIN Master List
    const masterRef = db.collection('master_client_list').doc(String(pid).trim());
    batch.set(masterRef, clientData, { merge: true });

    // 2. Update FRANCHISE OWNER List
    const ownerEmail = franMap[franId];
    if (ownerEmail) {
        const accRef = db.collection('accounts').doc(`ACC_${pid}`);
        batch.set(accRef, {
            ...clientData,
            owner: ownerEmail,
        }, { merge: true });
    } else {
        // NEW: Log a warning if the link fails!
        log(`‚ö†Ô∏è ORPHAN WARNING: Client ${pid} (${clientData.name}) added to Master, but Fran ID '${franId}' has no matching Owner in DB.`, 'warn');
        orphanCount++;
    }

    count++;
    updatedCount++;

    if (count % 400 === 0) {
        await batch.commit();
        batch = db.batch();
        log(`Batch ${count/400} committed...`);
    }
}
await batch.commit();
log(`‚úÖ Sync Complete. Upserted ${updatedCount} records.`, 'success');
if(orphanCount > 0) log(`‚ö†Ô∏è ${orphanCount} accounts were NOT assigned to franchisees (Check Fran IDs).`, 'warn');
resetUI();
}

    // --- 2. ROBUST CANCELLED LIST IMPORT (FORCE INACTIVE) ---
async function uploadCancelledList(data) {
log(`Starting Cancelled List Import (${data.length} records)...`);

// DEBUG: Show us what headers the script actually sees in the first row
if (data.length > 0) {
    console.log("Headers detected:", Object.keys(data[0]));
    log(`‚ÑπÔ∏è Debug: First row headers are: [${Object.keys(data[0]).join(', ')}]`);
}

let batch = db.batch();
let count = 0;
let skippedCount = 0;

for (const row of data) {
    // 1. ROBUST ID CHECK: Check all common names for the ID column
    const pid = row['Client ID'] || row['Clientid'] || row['PID'] || row['Property ID'] || row['Account'] || row['id'];

    if (!pid) {
        skippedCount++;
        continue; // Skip if we still can't find an ID
    }

    const franId = (row['Fran ID'] || row['FranID'] || '').trim().toUpperCase();
    const cancelDateRaw = row['Cancel Date'] || row['CancelDate'];
    const formattedCancelDate = formatDate(cancelDateRaw);

    // Basic data cleaning
    const addr = (row['Site Address'] || row['Address'] || '').trim();
    const city = (row['Site City'] || row['City'] || '').trim();
    const state = (row['Site State'] || row['State'] || '').trim() || 'PA';
    const zip = (row['Site Zip'] || row['Zip'] || '').trim();
    const fullAddress = [addr, city, state, zip].filter(Boolean).join(', ');

    // 2. Prepare Payload
    const inactivePayload = {
        pid: String(pid).trim(), // Ensure ID is a string
        name: row['Service Loc'] || row['Service Location Name'] || '',
        address: fullAddress,
        franId: franId,

        // KEY STATUS UPDATES
        endDate: formattedCancelDate || firebase.firestore.FieldValue.serverTimestamp(),
        status: 'Inactive', // FORCE INACTIVE
        inactiveReason: 'Imported from Cancelled List',
        lastImportedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // 3. Update ADMIN Master List
    const masterRef = db.collection('master_client_list').doc(inactivePayload.pid);
    batch.set(masterRef, inactivePayload, { merge: true });

    // 4. FORCE UPDATE Franchisee Account (Blind Upsert)
    // We find the account by PID and force it Inactive.
    const accRef = db.collection('accounts').doc(`ACC_${inactivePayload.pid}`);

    const accPayload = {
        status: 'Inactive',
        endDate: inactivePayload.endDate,
        inactiveReason: inactivePayload.inactiveReason,
        lastImportedAt: inactivePayload.lastImportedAt
    };

    if (inactivePayload.name) accPayload.name = inactivePayload.name;
    if (inactivePayload.revenue) accPayload.revenue = parseFloat((row['Recur Amt']||'0').replace(/[$,]/g, ''));

    batch.set(accRef, accPayload, { merge: true });

    count++;
    if (count % 400 === 0) {
        await batch.commit();
        batch = db.batch();
        log(`Processed ${count} rows...`);
    }
}

if (count > 0) {
    await batch.commit();
    log(`‚úÖ Cancelled Import Complete. FORCED ${count} records to Inactive.`, 'success');
} else {
    log(`‚ùå Error: Could not find any valid IDs. Check the debug log above for header names.`, 'error');
}

if (skippedCount > 0) {
    log(`‚ö†Ô∏è Skipped ${skippedCount} rows (Missing 'PID' or 'Client ID').`, 'warn');
}

resetUI();
}

    // --- 3. LEGACY HISTORY IMPORT ---
    async function uploadHistoryBook(data) {
        log("Uploading Legacy History...");
        let batch = db.batch(); let count = 0; let batchCount = 0;

        for (const row of data) {
            const clientId = row['Client'];
            if (!clientId) continue;

            const accRef = db.collection('accounts').doc(`ACC_${clientId}`);
            const accData = {
                pid: clientId,
                name: `Client ${clientId}`,
                revenue: parseFloat((row['Recur Amt']||'0').replace(/[$,]/g, '')),
                startDate: formatDate(row['Start Date']),
                status: 'Active',
                owner: ALLOWED_ADMIN_EMAIL,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            batch.set(accRef, accData, { merge: true });
            count++; batchCount++;
            if (batchCount >= 400) { await batch.commit(); batch = db.batch(); batchCount = 0; }
        }
        await batch.commit();
        log(`‚úÖ Processed ${count} Accounts for initial setup.`);
        resetUI();
    }

    // --- SMART SYNC (Maintenance) ---
    async function runSmartSync() {
        if(!confirm("Fix missing split-address fields on existing Franchisee accounts?")) return;
        log("Running Smart Sync...");
        const snap = await db.collection('master_client_list').get();
        const masterData = {};
        snap.forEach(doc => masterData[doc.id] = doc.data());

        const accSnap = await db.collection('accounts').get();
        let batch = db.batch(); let ops = 0;

        accSnap.forEach(doc => {
            const acc = doc.data();
            const pid = acc.pid || doc.id.replace('ACC_', '');
            const m = masterData[pid];

            if (m && m.street && !acc.street) {
                batch.update(doc.ref, {
                    street: m.street, city: m.city, state: m.state, zip: m.zip,
                    lat: m.lat, lng: m.lng
                });
                ops++;
            }
            if(ops >= 400) { batch.commit(); batch = db.batch(); ops = 0; }
        });
        if(ops > 0) await batch.commit();
        log(`‚úÖ Sync Done. Updated ${ops} documents.`);
    }

    // --- UTILS ---
    function formatDate(dateStr) {
        if(!dateStr) return null;
        // Handle MM/DD/YYYY or M/D/YY
        const parts = dateStr.trim().replace(/-/g, '/').split('/');
        if(parts.length === 3) {
            let y = parts[2];
            if (y.length === 2) y = "20" + y;
            const m = parts[0].padStart(2,'0');
            const d = parts[1].padStart(2,'0');
            return `${y}-${m}-${d}`;
        }
        return null; // Invalid date
    }

    function resetUI() {
        const btn = document.getElementById('btnUpload');
        btn.disabled = false;
        btn.classList.remove('disabled-state');
        btn.innerText = "Start Import";
    }

    async function checkRecordCount() {
        try { const snap = await db.collection('master_client_list').get(); alert(`Master Client List contains: ${snap.size} records.`); } catch(e) { alert(e); }
    }

    async function wipeMasterList() {
        if(!confirm("‚ö†Ô∏è DANGER: Are you sure you want to DELETE the Master Client List?")) return;
        if(prompt("Type DELETE to confirm") !== "DELETE") return;
        const snap = await db.collection('master_client_list').get();
        let batch = db.batch(); let count = 0;
        for(const doc of snap.docs) {
            batch.delete(doc.ref); count++;
            if(count >= 400) { await batch.commit(); batch = db.batch(); count = 0; }
        }
        await batch.commit();
        alert(`Master Client List Wiped.`);
    }
</script>
</body>
</html>