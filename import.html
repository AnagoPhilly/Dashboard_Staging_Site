<!DOCTYPE html>
<html>
<head>
    <title>CleanDash Admin Importer</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; background: #f3f4f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 700px; }
        h1 { color: #0d9488; margin-top: 0; font-size: 1.5rem; border-bottom: 2px solid #f0fdfa; padding-bottom: 15px; margin-bottom: 20px; }

        .upload-box { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px; background: #f8fafc; margin: 20px 0; }

        select, .checkbox-wrapper { width: 100%; margin-bottom: 15px; font-size: 1rem; }
        select { padding: 12px; border-radius: 6px; border: 1px solid #d1d5db; background: white; }

        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; background: #e0f2fe; padding: 10px; border-radius: 6px; border: 1px solid #bae6fd; color: #0369a1; font-weight: 600; box-sizing: border-box;}

        button { background: #0d9488; color: white; border: none; padding: 12px 24px; font-size: 1rem; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: background 0.2s; }
        button:hover { background: #0f766e; }
        button.disabled-state { background: #9ca3af !important; cursor: not-allowed !important; opacity: 0.7; }

        .log-window { background: #1f2937; color: #10b981; padding: 15px; height: 250px; overflow-y: auto; border-radius: 8px; margin-top: 20px; font-family: monospace; font-size: 0.85rem; display: none; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #374151; padding-bottom: 2px; }
        .log-warn { color: #f59e0b; }
        .log-error { color: #ef4444; font-weight: bold; }

        .danger-zone { margin-top: 30px; padding-top: 20px; border-top: 2px solid #fee2e2; display: flex; gap: 10px; }
        .btn-danger { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
        .btn-danger:hover { background: #ef4444; color: white; }
        .btn-info { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .btn-info:hover { background: #0ea5e9; color: white; }

        #authWarning { display:none; background:#fee2e2; color:#991b1b; padding:15px; border-radius:8px; text-align:center; font-weight:bold; margin-bottom:20px; border:1px solid #f87171; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Admin Data Importer</h1>
    <div id="authWarning">üîí Access Denied. Must be logged in as Admin.</div>

    <div id="appContent" style="opacity:0.5; pointer-events:none;">
        <label style="font-weight:bold; color:#374151;">Select Import Type:</label>
        <select id="importType">
            <option value="master">1. Master Client List (clients.csv)</option>
            <option value="history">2. Account History/Book (Book.csv)</option>
        </select>

        <div class="checkbox-wrapper">
            <input type="checkbox" id="geoEnabled" checked>
            <label for="geoEnabled">Auto-Fix Map Coordinates (Adds ~0.6s per row)</label>
        </div>

        <div class="upload-box">
            <input type="file" id="uploadCsv" accept=".csv" />
        </div>

        <button id="btnUpload" class="disabled-state" disabled onclick="processFile()">üöÄ Start Import</button>

        <div id="status" style="margin-top:15px; text-align:center; font-weight:bold; color: #4b5563; min-height: 20px;"></div>
        <div id="log" class="log-window"></div>

        <div class="danger-zone">
            <button onclick="checkRecordCount()" class="btn-info">üìä Check Record Count</button>
            <button onclick="wipeMasterList()" class="btn-danger">üóëÔ∏è Delete All Master Data</button>
        </div>
    </div>
</div>

<script src="js/auth.js"></script>

<script>
    const ALLOWED_ADMIN_EMAIL = 'nate@anagophilly.com';
    const LOCATIONIQ_KEY = "pk.c92dcfda3c6ea1c6da25f0c36c34c99e";

    firebase.auth().onAuthStateChanged(user => {
        const warningBox = document.getElementById('authWarning');
        const appContent = document.getElementById('appContent');
        const btn = document.getElementById('btnUpload');

        if (user && user.email && user.email.toLowerCase() === ALLOWED_ADMIN_EMAIL.toLowerCase()) {
            warningBox.style.display = 'none';
            appContent.style.opacity = '1';
            appContent.style.pointerEvents = 'auto';
            btn.disabled = false;
            btn.classList.remove('disabled-state');
        } else {
            warningBox.style.display = 'block';
            appContent.style.opacity = '0.5';
            appContent.style.pointerEvents = 'none';
        }
    });

    function log(msg, type='info') {
        const l = document.getElementById('log');
        l.style.display = 'block';
        let cls = 'log-entry';
        if(type==='warn') cls += ' log-warn';
        if(type==='error') cls += ' log-error';
        l.innerHTML += `<div class="${cls}">> ${msg}</div>`;
        l.scrollTop = l.scrollHeight;
    }

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    async function getCoordinates(address) {
        if (!address || address.length < 5) return null;
        try {
            const url = `https://us1.locationiq.com/v1/search.php?key=${LOCATIONIQ_KEY}&q=${encodeURIComponent(address)}&format=json&limit=1`;
            const res = await fetch(url);
            if (!res.ok) return null;
            const data = await res.json();
            if (data && data[0]) {
                return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
            }
        } catch (e) { console.log("Geo error", e); }
        return null;
    }

    function processFile() {
        const file = document.getElementById('uploadCsv').files[0];
        const mode = document.getElementById('importType').value;

        if(!file) return alert("Please select a CSV file first.");

        const btn = document.getElementById('btnUpload');
        btn.disabled = true;
        btn.classList.add('disabled-state');
        btn.innerText = "Processing...";
        document.getElementById('log').innerHTML = '';

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            transformHeader: h => h.trim(),
            complete: function(results) {
                if(mode === 'master') uploadMasterList(results.data, results.meta.fields);
                else uploadHistoryBook(results.data, results.meta.fields);
            },
            error: function(err) {
                alert("CSV Error: " + err.message);
                btn.disabled = false;
                btn.classList.remove('disabled-state');
            }
        });
    }

    async function uploadMasterList(data, headers) {
        log(`Starting Master List Upload...`);
        log(`Headers Found: [${headers.join(', ')}]`);

        const hasFranCol = headers.some(h => ['Fran ID', 'FranID', 'Franchisee', 'Owner'].includes(h));
        if(!hasFranCol) log("WARNING: No 'Fran ID' column found in CSV. Auto-linking will not work.", 'warn');

        const doGeo = document.getElementById('geoEnabled').checked; // Check geocoding toggle
        const batchSize = 400;
        let batch = db.batch();
        let count = 0;

        for (const row of data) {
            const pid = row['Client ID'];
            if (!pid) {
                log(`Skipping row: Missing 'Client ID'`, 'warn');
                continue;
            }

            let cleanRev = row['Recur Amt'] ? parseFloat(row['Recur Amt'].replace(/[$,]/g, '')) : 0;
            let cleanDate = formatDate(row['Start Date']);
            const franId = row['Fran ID'] || row['FranID'] || row['Franchisee'] || '';

            // --- NEW: Better Address Construction with Commas ---
            const addr = row['Site Address'] || '';
            const city = row['Site City'] || '';
            const state = row['Site State'] || '';
            const zip = row['Site Zip'] || '';

            let fullAddress = addr;
            if(city) fullAddress += `, ${city}`;
            if(state) fullAddress += `, ${state}`;
            if(zip) fullAddress += ` ${zip}`;
            fullAddress = fullAddress.trim();

            // --- NEW: Geocoding Logic for Master List ---
            let lat = null;
            let lng = null;
            if (doGeo && fullAddress.length > 10) {
                await sleep(650); // Pause to respect API limits
                const coords = await getCoordinates(fullAddress);
                if (coords) {
                    lat = coords.lat;
                    lng = coords.lng;
                    log(`üìç Pin found: ${pid} (${city})`);
                } else {
                    log(`‚ö†Ô∏è No pin: ${pid}`, 'warn');
                }
            }

            const docRef = db.collection('master_client_list').doc(String(pid).trim());

            const clientData = {
                pid: pid,
                name: row['Service Location Name'] || '',
                address: fullAddress, // Save the comma-formatted address
                revenue: cleanRev,
                startDate: cleanDate,
                contactName: row['Contact Name'] || '',
                contactPhone: row['Contact Phone'] || '',
                contactEmail: row['Contact Email'] || '',
                franId: franId.trim(),
                lastImportedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (lat && lng) {
                clientData.lat = lat;
                clientData.lng = lng;
            }

            batch.set(docRef, clientData, { merge: true });

            count++;
            if (count % batchSize === 0) {
                await batch.commit();
                log(`Synced ${count} records...`);
                batch = db.batch();
            }
        }
        if (count > 0) await batch.commit();

        document.getElementById('status').innerText = `‚úÖ Master List Updated (${count} records)`;
        document.getElementById('btnUpload').disabled = false;
        document.getElementById('btnUpload').classList.remove('disabled-state');
        document.getElementById('btnUpload').innerText = "Start Import";
        alert("Master List Updated! Now you can run the Franchisee Import.");
    }

    async function uploadHistoryBook(data, headers) {
        log("Starting History Import...");
        log(`Headers Found: [${headers.join(', ')}]`);

        if(!headers.includes('Client')) {
            log("CRITICAL ERROR: 'Client' column not found in CSV!", 'error');
            alert("Error: Your CSV is missing the 'Client' column.");
            document.getElementById('btnUpload').disabled = false;
            return;
        }

        const doGeo = document.getElementById('geoEnabled').checked;
        const batchSize = 400;
        let batch = db.batch();
        let count = 0;
        let created = 0;
        let batchCounter = 0;

        for (const row of data) {
            const rawType = row['Type'] || '';
            const type = rawType.trim();
            const clientId = row['Client'];

            if (!clientId) {
                log("Skipping row: Missing 'Client' ID", 'warn');
                continue;
            }

            // Lookup Master Data
            let masterData = {};
            try {
                const snap = await db.collection('master_client_list').doc(String(clientId).trim()).get();
                if (snap.exists) masterData = snap.data();
            } catch(e) {}

            const finalName = masterData.name || `Client ${clientId}`;
            // Fallback to master data address if available (it has commas now!)
            const finalAddr = masterData.address || 'Address Lookup Failed';

            // --- SMART STATUS LOGIC ---
            const isOneTime = type.toLowerCase().includes('1x job');
            let isInactive = (type === 'Inactive' || type.startsWith('Transfer') || isOneTime);

            let endDate = null;
            let inactiveReason = null;

            if (isInactive) {
                if (isOneTime) {
                    inactiveReason = 'One-Time Job';
                    endDate = formatDate(row['Start Date']) || new Date().toISOString().split('T')[0];
                } else if (type.includes('Transfer')) {
                    inactiveReason = type;
                } else {
                    inactiveReason = 'Past Service';
                }

                let endRaw = row['Transfer Date'];
                if (!endRaw || endRaw.trim() === '') endRaw = row['Last Clean'];
                if (!endRaw || endRaw.trim() === '') endRaw = row['Last Responsible'];
                if (endRaw) endDate = formatDate(endRaw);
                if (!endDate) endDate = new Date().toISOString().split('T')[0];
            }

            const startDate = formatDate(row['Start Date']);
            let revenue = 0;
            if(row['Recur Amt']) {
                 revenue = parseFloat(row['Recur Amt'].replace(/[$,]/g, ''));
            }

            // Geocoding (Only if master data didn't have it)
            let lat = masterData.lat || null;
            let lng = masterData.lng || null;

            if (doGeo && !lat && finalAddr && finalAddr.length > 5) {
                await sleep(600);
                const coords = await getCoordinates(finalAddr);
                if (coords) {
                    lat = coords.lat;
                    lng = coords.lng;
                    log(`üìç Found pin for: ${clientId}`);
                }
            }

            const accRef = db.collection('accounts').doc(`ACC_${clientId}`);
            const accData = {
                pid: clientId,
                name: finalName,
                address: finalAddr,
                revenue: revenue,
                startDate: startDate,
                endDate: endDate,
                status: isInactive ? 'Inactive' : 'Active',
                inactiveReason: inactiveReason,
                contactName: masterData.contactName || '',
                contactPhone: masterData.contactPhone || '',
                contactEmail: masterData.contactEmail || '',
                owner: ALLOWED_ADMIN_EMAIL,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if(lat && lng) {
                accData.lat = lat;
                accData.lng = lng;
            }

            batch.set(accRef, accData, { merge: true });

            count++;
            created++;
            batchCounter++;

            if (batchCounter >= batchSize) {
                await batch.commit();
                log(`üíæ Saved batch of ${batchSize} accounts...`);
                batch = db.batch();
                batchCounter = 0;
            }
        }

        if (batchCounter > 0) await batch.commit();

        document.getElementById('status').innerText = `‚úÖ Processed ${created} Accounts!`;
        document.getElementById('btnUpload').disabled = false;
        document.getElementById('btnUpload').classList.remove('disabled-state');
        document.getElementById('btnUpload').innerText = "Start Import";
        alert(`Import Complete! Processed ${created} records.`);
    }

    function formatDate(dateStr) {
        if(!dateStr) return '';
        const parts = dateStr.trim().replace(/\//g, '-').split('-');
        if(parts.length === 3) {
            let y = parts[2];
            if(y.length === 2) y = '20' + y;
            return `${y}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
        }
        return '';
    }

    async function checkRecordCount() {
        document.getElementById('status').innerText = "Checking...";
        try {
            const snap = await db.collection('master_client_list').get();
            alert(`Master List contains: ${snap.size} records.`);
            document.getElementById('status').innerText = `Count: ${snap.size} records`;
        } catch(e) { alert("Error checking: " + e.message); }
    }

    async function wipeMasterList() {
        if(!confirm("‚ö†Ô∏è DANGER: This deletes the Master Client List. Continue?")) return;
        const confirmation = prompt("Type DELETE to confirm:");
        if (confirmation !== "DELETE") return;

        document.getElementById('status').innerText = "DELETING... Please wait.";
        try {
            const collectionRef = db.collection('master_client_list');
            const snapshot = await collectionRef.get();

            if (snapshot.size === 0) {
                document.getElementById('status').innerText = "Already Empty.";
                return alert("List is already empty.");
            }

            let batch = db.batch();
            let count = 0;

            for (const doc of snapshot.docs) {
                batch.delete(doc.ref);
                count++;
                if (count >= 400) {
                    await batch.commit();
                    batch = db.batch();
                    count = 0;
                }
            }

            if (count > 0) await batch.commit();

            alert("Master List Wiped.");
            document.getElementById('status').innerText = "Database Empty (0 Records)";
        } catch (e) { alert("Error: " + e.message); }
    }
</script>
</body>
</html>