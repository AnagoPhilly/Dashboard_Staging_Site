<!DOCTYPE html>
<html>
<head>
    <title>CleanDash Diagnostic Importer</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f3f4f6; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
        h1 { color: #0d9488; margin-top: 0; }

        .upload-box { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; background: #f8fafc; margin: 20px 0; }
        button { background: #0d9488; color: white; border: none; padding: 12px 20px; font-size: 1rem; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }

        #log { background: #1f2937; color: #10b981; padding: 15px; height: 350px; overflow-y: auto; border-radius: 8px; margin-top: 20px; font-family: monospace; font-size: 0.9rem; white-space: pre-wrap; }
        .error { color: #ef4444; font-weight: bold; background: rgba(239, 68, 68, 0.1); padding: 2px; }
        .warn { color: #f59e0b; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

<div class="container">
    <h1>üîß Diagnostic Importer</h1>
    <p>This tool prints detailed logs to find out why the upload is freezing.</p>

    <div class="upload-box">
        <input type="file" id="uploadCsv" accept=".csv" />
    </div>

    <button id="btnUpload" onclick="processFile()">Start Diagnostic Upload</button>
    <div id="log">Waiting for file...</div>
</div>

<script src="js/auth.js"></script>

<script>
    function log(msg, type = 'info') {
        const l = document.getElementById('log');
        const entry = document.createElement('div');
        entry.textContent = `> ${msg}`;
        if(type === 'error') entry.className = 'error';
        if(type === 'warn') entry.className = 'warn';
        l.appendChild(entry);
        l.scrollTop = l.scrollHeight;
        console.log(msg);
    }

    function processFile() {
        const file = document.getElementById('uploadCsv').files[0];
        if(!file) return alert("Select a file first.");

        const btn = document.getElementById('btnUpload');
        btn.disabled = true;
        document.getElementById('log').innerHTML = ''; // Clear log

        log("STEP 1: Checking User Auth...");
        const user = firebase.auth().currentUser;
        if(!user) {
            log("‚ùå ERROR: No user logged in. Please log in on the dashboard first.", "error");
            btn.disabled = false;
            return;
        }
        log(`‚úÖ User detected: ${user.email}`);

        log("STEP 2: Reading CSV file...");
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.data.length === 0) {
                    log("‚ùå ERROR: CSV file is empty.", "error");
                    btn.disabled = false;
                    return;
                }
                // Log the headers found to check for weird characters
                log(`‚ÑπÔ∏è Headers Found: [${results.meta.fields.join(', ')}]`);
                runDiagnosticUpload(results.data);
            },
            error: function(err) {
                log(`‚ùå CSV READ ERROR: ${err.message}`, "error");
                btn.disabled = false;
            }
        });
    }

    async function runDiagnosticUpload(data) {
        log(`STEP 3: Processing ${data.length} rows...`);

        // Check first row keys
        const firstRow = data[0];
        const keys = Object.keys(firstRow);
        const pidKey = keys.find(k => k.includes('Client ID')); // Fuzzy search

        if(!pidKey) {
            log("‚ùå FATAL ERROR: Could not find a column named 'Client ID'.", "error");
            log(`   Found these columns instead: ${keys.join(', ')}`, "warn");
            log("   Fix: Open CSV and ensure cell A1 says exactly 'Client ID'.", "warn");
            document.getElementById('btnUpload').disabled = false;
            return;
        }
        log(`‚úÖ Using '${pidKey}' as the ID column.`);

        const batch = db.batch();
        let count = 0;
        const limit = 5; // ONLY TRY 5 ROWS FIRST for safety

        log(`STEP 4: Attempting to upload FIRST 5 ROWS to test connection...`);

        try {
            for (let i = 0; i < Math.min(data.length, limit); i++) {
                const row = data[i];
                const pid = row[pidKey];

                if(!pid) {
                    log(`‚ö†Ô∏è Skipped Row ${i+1}: Missing ID`);
                    continue;
                }

                const docRef = db.collection('master_client_list').doc(String(pid).trim());
                batch.set(docRef, {
                    pid: pid,
                    test_upload: true,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                count++;
            }

            if(count === 0) {
                log("‚ùå Error: No valid rows found in first 5 lines.", "error");
                return;
            }

            log(`‚è≥ Sending data to Firebase... (Please wait)`);
            await batch.commit();
            log(`‚úÖ SUCCESS! Firebase Connection is Working.`, "warn");
            log(`   (Test batch of ${count} records saved.)`);

            // If we get here, connection is good. Now do the real upload.
            if(confirm("Test successful! Ready to upload the full list?")) {
                uploadFullList(data, pidKey);
            }

        } catch (e) {
            log(`‚ùå FIREBASE ERROR: ${e.code}`, "error");
            log(`   Message: ${e.message}`, "error");
            log(`   HINT: This usually means 'Firestore Rules' are blocking you.`, "warn");
        }

        document.getElementById('btnUpload').disabled = false;
    }

    async function uploadFullList(data, pidKey) {
        log("--- STARTING FULL UPLOAD ---");
        const batchSize = 400;
        let batch = db.batch();
        let count = 0;
        let batchCount = 0;

        for (const row of data) {
            const pid = row[pidKey];
            if (!pid) continue;

            // Clean Data
            let cleanRev = 0;
            if(row['Recur Amt']) cleanRev = parseFloat(row['Recur Amt'].replace(/[$,]/g, ''));

            let cleanDate = '';
            if(row['Start Date']) {
                const parts = row['Start Date'].split('-');
                if(parts.length === 3) cleanDate = `20${parts[2]}-${parts[0]}-${parts[1]}`;
            }

            const docRef = db.collection('master_client_list').doc(String(pid).trim());
            batch.set(docRef, {
                pid: pid,
                name: row['Service Location Name'] || '',
                address: `${row['Site Address']||''} ${row['Site City']||''} ${row['Site State']||''} ${row['Site Zip']||''}`.trim(),
                revenue: cleanRev,
                startDate: cleanDate,
                contactName: row['Contact Name'] || '',
                contactPhone: row['Contact Phone'] || '',
                contactEmail: row['Contact Email'] || '',
                uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            count++;
            if (count >= batchSize) {
                await batch.commit();
                batchCount++;
                log(`Saved Batch ${batchCount} (${count} records)`);
                batch = db.batch();
                count = 0;
            }
        }

        if (count > 0) {
            await batch.commit();
            log(`Saved Final Batch (${count} records)`);
        }

        log("üéâ FULL UPLOAD COMPLETE!");
        alert("Success! All data uploaded.");
    }
</script>
</body>
</html>