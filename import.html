<!DOCTYPE html>
<html>
<head>
    <title>CleanDash Admin Importer</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 700px; }
        h1 { color: #0d9488; margin-top: 0; border-bottom: 2px solid #f0fdfa; padding-bottom: 15px; margin-bottom: 20px; }
        .upload-box { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px; background: #f8fafc; margin: 20px 0; }
        select, .checkbox-wrapper { width: 100%; margin-bottom: 15px; font-size: 1rem; }
        select { padding: 12px; border-radius: 6px; border: 1px solid #d1d5db; background: white; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; background: #e0f2fe; padding: 10px; border-radius: 6px; border: 1px solid #bae6fd; color: #0369a1; font-weight: 600; box-sizing: border-box;}
        button { background: #0d9488; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; transition: 0.2s; }
        button:hover { background: #0f766e; }
        button.disabled-state { background: #9ca3af !important; cursor: not-allowed; opacity: 0.7; }
        .log-window { background: #1f2937; color: #10b981; padding: 15px; height: 300px; overflow-y: auto; border-radius: 8px; margin-top: 20px; font-family: monospace; font-size: 0.85rem; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #374151; padding-bottom: 2px; }
        .log-warn { color: #f59e0b; }
        .log-error { color: #ef4444; font-weight: bold; }
        .log-success { color: #34d399; font-weight: bold; }
        .btn-sync { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
        .btn-sync:hover { background: #dbeafe; }
        .btn-danger { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
        .btn-danger:hover { background: #ef4444; }
        #authWarning { display:none; background:#fee2e2; color:#991b1b; padding:15px; border-radius:8px; text-align:center; font-weight:bold; margin-bottom:20px; border:1px solid #f87171; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Admin Data Importer</h1>
    <div id="authWarning">üîí Access Denied. Must be logged in as Admin.</div>

    <div id="appContent" style="opacity:0.5; pointer-events:none;">
        <label style="font-weight:bold; color:#374151;">Select Import Type:</label>
        <select id="importType">
            <option value="master">1. Master Client List (clients.csv)</option>
            <option value="history">2. Account History/Book (Book.csv)</option>
        </select>

        <div class="checkbox-wrapper">
            <input type="checkbox" id="geoEnabled" checked>
            <label for="geoEnabled">Auto-Fix Map Coordinates (Adds ~0.6s per row)</label>
        </div>

        <div class="upload-box">
            <input type="file" id="uploadCsv" accept=".csv" />
        </div>

        <button id="btnUpload" class="disabled-state" disabled onclick="processFile()">üöÄ Start Import</button>
        <button onclick="runSmartSync()" class="btn-sync">üß† Run Smart GPS & PID Sync (Name Match)</button>

        <div id="status" style="margin-top:15px; text-align:center; font-weight:bold; color: #4b5563; min-height: 20px;"></div>
        <div id="log" class="log-window"></div>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="checkRecordCount()" style="background:#e0f2fe; color:#0369a1;">üìä Check Counts</button>
            <button onclick="wipeMasterList()" class="btn-danger">üóëÔ∏è Wipe Master Data</button>
        </div>
    </div>
</div>

<script src="js/auth.js"></script>
<script src="js/utils.js"></script>

<script>
    const ALLOWED_ADMIN_EMAIL = 'nate@anagophilly.com';
    const API_KEY = window.LOCATIONIQ_KEY || "pk.c92dcfda3c6ea1c6da25f0c36c34c99e";

    firebase.auth().onAuthStateChanged(user => {
        const warningBox = document.getElementById('authWarning');
        const appContent = document.getElementById('appContent');
        const btn = document.getElementById('btnUpload');

        if (user && user.email && user.email.toLowerCase() === ALLOWED_ADMIN_EMAIL.toLowerCase()) {
            warningBox.style.display = 'none';
            appContent.style.opacity = '1';
            appContent.style.pointerEvents = 'auto';
            btn.disabled = false;
            btn.classList.remove('disabled-state');
        } else {
            warningBox.style.display = 'block';
            appContent.style.opacity = '0.5';
            appContent.style.pointerEvents = 'none';
        }
    });

    function log(msg, type='info') {
        const l = document.getElementById('log');
        let cls = 'log-entry';
        if(type==='warn') cls += ' log-warn';
        if(type==='error') cls += ' log-error';
        if(type==='success') cls += ' log-success';
        l.innerHTML += `<div class="${cls}">> ${msg}</div>`;
        l.scrollTop = l.scrollHeight;
    }

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // --- 1. STRUCTURED GEOCODING (Fixes Pin Accuracy) ---
    async function getCoordinates(street, city, state, zip) {
        if (!street) return null;
        try {
            // Use STRUCTURED query for max accuracy
            const baseUrl = "https://us1.locationiq.com/v1/search.php";
            const params = new URLSearchParams({
                key: API_KEY,
                street: street,
                city: city,
                state: state,
                postalcode: zip,
                format: 'json',
                limit: 1,
                countrycodes: 'us'
            });

            const res = await fetch(`${baseUrl}?${params.toString()}`);
            const data = await res.json();
            if (data && data[0]) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        } catch (e) { console.log("Geo error", e); }
        return null;
    }

    function processFile() {
        const file = document.getElementById('uploadCsv').files[0];
        const mode = document.getElementById('importType').value;
        if(!file) return alert("Select CSV");
        const btn = document.getElementById('btnUpload');
        btn.disabled = true; btn.classList.add('disabled-state'); btn.innerText = "Processing...";

        Papa.parse(file, {
            header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
            complete: function(results) {
                if(mode === 'master') uploadMasterList(results.data, results.meta.fields);
                else uploadHistoryBook(results.data, results.meta.fields);
            },
            error: function(err) { alert(err.message); btn.disabled = false; }
        });
    }

    // --- 2. UPLOAD MASTER LIST (Saves Split Fields) ---
    async function uploadMasterList(data, headers) {
        log("Uploading Master List...");
        const doGeo = document.getElementById('geoEnabled').checked;
        let batch = db.batch(); let count = 0;

        for (const row of data) {
            const pid = row['Client ID']; if (!pid) continue;

            // Parse fields explicitly
            const addr = (row['Site Address'] || '').trim();
            const city = (row['Site City'] || '').trim();
            const state = (row['Site State'] || 'PA').trim();
            const zip = (row['Site Zip'] || '').trim();

            // Reconstruct full address for display
            const fullAddress = [addr, city, state, zip].filter(Boolean).join(', ');

            let lat = null, lng = null;
            if (doGeo && addr.length > 3) {
                await sleep(650); // Rate limit
                const coords = await getCoordinates(addr, city, state, zip);
                if (coords) { lat = coords.lat; lng = coords.lng; log(`üìç Pin: ${pid}`); }
            }

            const docRef = db.collection('master_client_list').doc(String(pid).trim());

            // CRITICAL FIX: Saving 'street', 'city', 'state', 'zip' separately
            const clientData = {
                pid: pid,
                name: row['Service Location Name'] || '',
                address: fullAddress, // Kept for display
                street: addr, // <--- NEW
                city: city,   // <--- NEW
                state: state, // <--- NEW
                zip: zip,     // <--- NEW
                revenue: parseFloat((row['Recur Amt']||'0').replace(/[$,]/g, '')),
                contactName: row['Contact Name'] || '',
                contactPhone: row['Contact Phone'] || '',
                contactEmail: row['Contact Email'] || '',
                franId: (row['Fran ID'] || row['FranID'] || '').trim(),
                lastImportedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            if (lat) { clientData.lat = lat; clientData.lng = lng; }

            batch.set(docRef, clientData, { merge: true });
            count++;
            if (count % 400 === 0) { await batch.commit(); batch = db.batch(); }
        }
        await batch.commit();
        log(`‚úÖ Master List Updated (${count})`);
        document.getElementById('btnUpload').disabled = false;
        document.getElementById('btnUpload').classList.remove('disabled-state');
        document.getElementById('btnUpload').innerText = "Start Import";
    }

    async function uploadHistoryBook(data, headers) {
        log("Uploading History...");
        if(!headers.includes('Client')) return alert("Missing 'Client' column");
        const doGeo = document.getElementById('geoEnabled').checked;
        let batch = db.batch(); let count = 0; let batchCount = 0;

        for (const row of data) {
            const clientId = row['Client']; if (!clientId) continue;

            // Lookup Master
            let masterData = {};
            try {
                const snap = await db.collection('master_client_list').doc(String(clientId).trim()).get();
                if(snap.exists) masterData = snap.data();
            } catch(e) {}

            const finalName = masterData.name || `Client ${clientId}`;
            const finalAddr = masterData.address || 'Address Lookup Failed';
            let lat = masterData.lat || null;
            let lng = masterData.lng || null;

            if (doGeo && !lat && finalAddr.length > 5) {
                await sleep(600);
                // Fallback using single string if master data missing
                const coords = await getCoordinates(finalAddr, '', '', '');
                if (coords) { lat = coords.lat; lng = coords.lng; log(`üìç Fallback Pin: ${clientId}`); }
            }

            // Create Account Doc
            const accRef = db.collection('accounts').doc(`ACC_${clientId}`);
            const accData = {
                pid: clientId, name: finalName, address: finalAddr,
                revenue: parseFloat((row['Recur Amt']||'0').replace(/[$,]/g, '')),
                startDate: formatDate(row['Start Date']),
                status: 'Active',
                contactName: masterData.contactName || '', contactPhone: masterData.contactPhone || '',
                contactEmail: masterData.contactEmail || '', owner: ALLOWED_ADMIN_EMAIL,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),

                // Copy split fields if available
                street: masterData.street || '',
                city: masterData.city || '',
                state: masterData.state || '',
                zip: masterData.zip || ''
            };
            if(lat) { accData.lat = lat; accData.lng = lng; }

            batch.set(accRef, accData, { merge: true });
            count++; batchCount++;
            if (batchCount >= 400) { await batch.commit(); batch = db.batch(); batchCount = 0; }
        }
        await batch.commit();
        log(`‚úÖ Processed ${count} Accounts`);
        document.getElementById('btnUpload').disabled = false;
        document.getElementById('btnUpload').classList.remove('disabled-state');
        document.getElementById('btnUpload').innerText = "Start Import";
    }

    // --- SMART SYNC (Backwards Compatibility) ---
    async function runSmartSync() {
        if(!confirm("Attempt to fix missing split-address fields on existing accounts?")) return;
        log("Running Sync...");
        const snap = await db.collection('master_client_list').get();
        const masterData = {};
        snap.forEach(doc => masterData[doc.id] = doc.data());

        const accSnap = await db.collection('accounts').get();
        let batch = db.batch(); let ops = 0;

        accSnap.forEach(doc => {
            const acc = doc.data();
            const m = masterData[acc.pid] || masterData[doc.id.replace('ACC_', '')];

            if (m && m.street && !acc.street) {
                batch.update(doc.ref, {
                    street: m.street, city: m.city, state: m.state, zip: m.zip,
                    lat: m.lat, lng: m.lng // Sync pin too
                });
                ops++;
            }

            if(ops >= 400) { batch.commit(); batch = db.batch(); ops = 0; }
        });
        if(ops > 0) await batch.commit();
        log("Sync Done.");
    }

    function formatDate(dateStr) {
        if(!dateStr) return '';
        const parts = dateStr.trim().replace(/\//g, '-').split('-');
        if(parts.length === 3) return `20${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
        return '';
    }
    async function checkRecordCount() {
        try { const snap = await db.collection('master_client_list').get(); alert(`Master: ${snap.size}`); } catch(e) { alert(e); }
    }
    async function wipeMasterList() {
        if(!confirm("Wipe Master List?")) return;
        if(prompt("Type DELETE") !== "DELETE") return;
        const snap = await db.collection('master_client_list').get();
        let batch = db.batch(); let count = 0;
        for(const doc of snap.docs) {
            batch.delete(doc.ref); count++;
            if(count >= 400) { await batch.commit(); batch = db.batch(); count = 0; }
        }
        await batch.commit();
        alert("Wiped.");
    }
</script>
</body>
</html>